<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>IQ100 æ™ºåŠ›é—®ç­”</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #343541;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            width: 80%;
            max-width: 800px;
            text-align: center;
        }

        .state {
            display: none;
        }

        /* API Key è¾“å…¥çŠ¶æ€ */
        #apiKeyInput {
            width: 300px;
            padding: 10px;
            margin: 10px;
            border-radius: 5px;
            border: none;
        }

        /* æŒ‰é’®æ ·å¼ */
        .button {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            background-color: #565869;
            color: white;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: transform 0.2s;
        }

        .button:hover {
            background-color: #444654;
            transform: scale(1.05);
        }

        /* é¢˜ç›®æ ·å¼ */
        .question {
            font-size: 24px;
            margin: 20px 0;
            padding: 20px;
            background-color: #444654;
            border-radius: 10px;
        }

        .options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .option {
            padding: 15px;
            background-color: #565869;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .option:hover {
            transform: scale(1.02);
        }

        .option.correct {
            background-color: #4CAF50;
        }

        .option.wrong {
            background-color: #f44336;
        }

        /* åˆ†æ•°æ˜¾ç¤º */
        .score {
            font-size: 20px;
            margin: 10px 0;
        }

        /* æ˜Ÿæ˜ŸåŠ¨ç”» */
        .star {
            position: absolute;
            pointer-events: none;
            animation: star-explosion 1s ease-out forwards;
            transform-origin: center;
        }

        @keyframes star-explosion {
            0% {
                transform: translate(-50%, -50%) scale(0.1) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(1.5) rotate(var(--rotation));
                opacity: 0;
            }
        }

        /* éœ‡åŠ¨åŠ¨ç”» */
        .shake {
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid #ffffff3d;
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            color: #ff4444;
            background-color: rgba(255, 68, 68, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        /* ç¦ç”¨çŠ¶æ€çš„é€‰é¡¹æ ·å¼ */
        .option.disabled {
            pointer-events: none;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- API Key è¾“å…¥çŠ¶æ€ -->
        <div id="apiKeyState" class="state">
            <h1>ğŸ® IQ100 æ™ºåŠ›é—®ç­” ğŸ®</h1>
            <p>è¯·è¾“å…¥æ‚¨çš„ xAI API Key å¼€å§‹æ¸¸æˆ</p>
            <input type="password" id="apiKeyInput" placeholder="è¾“å…¥ API Key...">
            <button class="button" onclick="submitApiKey()">ç¡®è®¤ âœ¨</button>
        </div>

        <!-- å¼€å§‹æ¸¸æˆçŠ¶æ€ -->
        <div id="startState" class="state">
            <h1>ğŸ® å‡†å¤‡å¼€å§‹ ğŸ®</h1>
            <p>å‡†å¤‡å¥½æ¥å—æŒ‘æˆ˜äº†å—ï¼Ÿ</p>
            <button class="button" onclick="startGame()">å¼€å§‹æ¸¸æˆ ğŸš€</button>
        </div>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="loadingState" class="state">
            <h2>ğŸ¤” AI æ­£åœ¨æ€è€ƒä¸­...</h2>
            <div class="loading"></div>
        </div>

        <!-- ç­”é¢˜çŠ¶æ€ -->
        <div id="questionState" class="state">
            <div class="score">å¾—åˆ†: <span id="scoreDisplay">0</span></div>
            <div class="question" id="questionText"></div>
            <div class="options" id="optionsContainer"></div>
        </div>

        <!-- æ¸¸æˆç»“æŸçŠ¶æ€ -->
        <div id="endState" class="state">
            <h1>ğŸ® æ¸¸æˆç»“æŸ ğŸ®</h1>
            <h2>æœ€ç»ˆå¾—åˆ†: <span id="finalScore">0</span></h2>
            <button class="button" onclick="resetGame()">é‡æ–°å¼€å§‹ ğŸ”„</button>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€å’Œå˜é‡
        let currentState = 'apiKey';
        let apiKey = '';
        let score = 0;
        let questionCount = 0;
        let currentQuestion = null;
        let previousQuestions = [];
        let isGenerating = false; // æ·»åŠ çŠ¶æ€æ ‡è®°
        const TIMEOUT_DURATION = 30000; // 30ç§’è¶…æ—¶

        // åˆå§‹åŒ–
        window.onload = () => {
            showState('apiKey');
        };

        // æ˜¾ç¤ºçŠ¶æ€
        function showState(state) {
            document.querySelectorAll('.state').forEach(el => el.style.display = 'none');
            document.getElementById(state + 'State').style.display = 'block';
            currentState = state;
        }

        // æäº¤ API Key
        function submitApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ API Key');
                return;
            }
            
            // ç®€å•éªŒè¯ API Key æ ¼å¼
            if (!/^[a-zA-Z0-9-_]{30,}$/.test(key)) {
                alert('API Key æ ¼å¼ä¼¼ä¹ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥');
                return;
            }
            
            apiKey = key;
            showState('start');
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            score = 0;
            questionCount = 0;
            previousQuestions = [];
            document.getElementById('scoreDisplay').textContent = score;
            generateQuestion();
        }

        // ç”Ÿæˆé—®é¢˜
        async function generateQuestion() {
            if (isGenerating) return;
            isGenerating = true;
            
            // é‡ç½®åŠ è½½çŠ¶æ€çš„æ˜¾ç¤º
            document.getElementById('loadingState').innerHTML = `
                <h2>ğŸ¤” AI æ­£åœ¨æ€è€ƒä¸­...</h2>
                <div class="loading"></div>
            `;
            
            showState('loading');
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_DURATION);

            try {
                const prompt = `è¯·ç”Ÿæˆä¸€ä¸ªå°å­¦ç”Ÿçš„ç™¾ç§‘çŸ¥è¯†é—®ç­”é¢˜ç›®ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
                {
                    "question": "é—®é¢˜å†…å®¹",
                    "options": {
                        "A": "é€‰é¡¹A",
                        "B": "é€‰é¡¹B",
                        "C": "é€‰é¡¹C",
                        "D": "é€‰é¡¹D"
                    },
                    "answer": "æ­£ç¡®ç­”æ¡ˆå­—æ¯"
                }
                è¯·åªè¿”å›çº¯JSONæ ¼å¼ï¼Œä¸è¦åŠ å…¥å…¶ä»–æ–‡å­—ã€‚
                è¿™æ˜¯ä¹‹å‰å‡ºè¿‡çš„é¢˜ç›®è¯·ä¸è¦é‡å¤ï¼š${JSON.stringify(previousQuestions)}`;

                const response = await fetch('https://api.x.ai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "grok-beta",
                        messages: [{
                            role: "user",
                            content: prompt
                        }]
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status}`);
                }

                const data = await response.json();
                console.log('API Response:', data);

                const content = data.choices[0].message.content;
                let parsedQuestion;

                try {
                    // å°è¯•ç›´æ¥è§£æ
                    parsedQuestion = JSON.parse(content);
                } catch {
                    // å¦‚æœç›´æ¥è§£æå¤±è´¥ï¼Œå°è¯•æå– JSON
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) {
                        throw new Error('æ— æ³•è§£æè¿”å›çš„å†…å®¹ä¸º JSON æ ¼å¼');
                    }
                    parsedQuestion = JSON.parse(jsonMatch[0]);
                }

                // éªŒè¯é—®é¢˜æ ¼å¼
                if (!validateQuestion(parsedQuestion)) {
                    throw new Error('é¢˜ç›®æ ¼å¼ä¸æ­£ç¡®');
                }

                currentQuestion = parsedQuestion;
                previousQuestions.push(currentQuestion);
                showQuestion();

            } catch (error) {
                console.error('Error:', error);
                const errorMessage = error.name === 'AbortError' 
                    ? 'ç”Ÿæˆé¢˜ç›®è¶…æ—¶ï¼Œè¯·é‡è¯•' 
                    : `ç”Ÿæˆé¢˜ç›®å¤±è´¥: ${error.message}`;

                document.getElementById('loadingState').innerHTML = `
                    <h2>ğŸ˜¢ å‡ºé”™äº†</h2>
                    <div class="error-message">${errorMessage}</div>
                    <button class="button" onclick="generateQuestion()">é‡æ–°ç”Ÿæˆ ğŸ”„</button>
                `;
            } finally {
                isGenerating = false;
            }
        }

        // æ·»åŠ é—®é¢˜éªŒè¯å‡½æ•°
        function validateQuestion(question) {
            return question 
                && typeof question.question === 'string'
                && question.options
                && typeof question.options === 'object'
                && 'A' in question.options
                && 'B' in question.options
                && 'C' in question.options
                && 'D' in question.options
                && typeof question.answer === 'string'
                && ['A', 'B', 'C', 'D'].includes(question.answer);
        }

        // æ˜¾ç¤ºé—®é¢˜
        function showQuestion() {
            showState('question');
            document.getElementById('questionText').textContent = currentQuestion.question;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            Object.entries(currentQuestion.options).forEach(([key, value]) => {
                const button = document.createElement('div');
                button.className = 'option';
                button.textContent = `${key}. ${value}`;
                button.onclick = () => checkAnswer(key);
                optionsContainer.appendChild(button);
            });
        }

        // æ£€æŸ¥ç­”æ¡ˆ
        function checkAnswer(selected) {
            const options = document.querySelectorAll('.option');
            options.forEach(option => option.classList.add('disabled'));

            if (selected === currentQuestion.answer) {
                score += 10;
                document.getElementById('scoreDisplay').textContent = score;
                createStars();
                options[selected.charCodeAt(0) - 65].classList.add('correct');
            } else {
                document.body.classList.add('shake');
                setTimeout(() => document.body.classList.remove('shake'), 500);
                options[selected.charCodeAt(0) - 65].classList.add('wrong');
                options[currentQuestion.answer.charCodeAt(0) - 65].classList.add('correct');
            }

            questionCount++;
            setTimeout(() => {
                if (questionCount >= 10) {
                    endGame();
                } else {
                    generateQuestion();
                }
            }, 1500);
        }

        // ä¿®æ”¹åˆ›å»ºæ˜Ÿæ˜ŸåŠ¨ç”»å‡½æ•°
        function createStars() {
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            
            for (let i = 0; i < 30; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.textContent = 'â­';
                
                // éšæœºè§’åº¦å’Œè·ç¦»
                const angle = (Math.random() * 360) * (Math.PI / 180);
                const distance = Math.random() * 200 + 100; // 100-300px
                
                // è®¡ç®—ç›®æ ‡ä½ç½®
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                
                // è®¾ç½®åˆå§‹ä½ç½®åœ¨ä¸­å¿ƒ
                star.style.left = `${centerX}px`;
                star.style.top = `${centerY}px`;
                
                // è®¾ç½®åŠ¨ç”»å˜é‡
                star.style.setProperty('--tx', `${tx}px`);
                star.style.setProperty('--ty', `${ty}px`);
                star.style.setProperty('--rotation', `${Math.random() * 720 - 360}deg`);
                
                // éšæœºå¤§å°
                star.style.fontSize = `${Math.random() * 20 + 15}px`;
                
                document.body.appendChild(star);
                setTimeout(() => star.remove(), 1000);
            }
        }

        // ç»“æŸæ¸¸æˆ
        function endGame() {
            document.getElementById('finalScore').textContent = score;
            showState('end');
        }

        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            showState('start');
        }
    </script>
</body>
</html>
